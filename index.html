<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patchouli's AR Lesson</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/vconsole@3.15.0/dist/vconsole.min.js"></script>
    <script>
    window.vConsole = new VConsole();

    <script>
        // We define a custom component called 'ar-reticle'.
        // This is the logic that p5.js was missing.
        AFRAME.registerComponent('ar-reticle', {
            init: function () {
                this.xrHitTestSource = null;
                this.viewerSpace = null;
                this.refSpace = null;

                // When the scene is loaded, setup the event listener for entering AR
                this.el.sceneEl.addEventListener('enter-vr', (e) => {
                    let session = this.el.sceneEl.renderer.xr.getSession();
                    this.el.sceneEl.renderer.xr.addEventListener('sessionstart', (ev) => {
                        this.viewerSpace = session.viewerSpace;
                        session.requestReferenceSpace('local').then((space) => {
                            this.refSpace = space;
                        });
                        session.requestHitTestSource({ space: this.viewerSpace })
                            .then((source) => {
                                this.xrHitTestSource = source;
                            });
                    });
                });
            },

            // The 'tick' function runs every frame (like onDraw or update)
            tick: function () {
                if (!this.xrHitTestSource) return;

                const frame = this.el.sceneEl.frame;
                if (!frame) return;

                // ASK THE SYSTEM: "Did the ray hit anything?"
                const hitTestResults = frame.getHitTestResults(this.xrHitTestSource);

                if (hitTestResults.length > 0) {
                    const pose = hitTestResults[0].getPose(this.refSpace);

                    // Yes! Update visibility and position
                    this.el.setAttribute('visible', 'true');
                    this.el.object3D.position.copy(pose.transform.position);
                    this.el.object3D.quaternion.copy(pose.transform.orientation);
                } else {
                    // No hit. Hide the reticle.
                    this.el.setAttribute('visible', 'false');
                }
            }
        });

        // A simple component to spawn a box when you tap the screen
        AFRAME.registerComponent('tap-to-spawn', {
            init: function() {
                const scene = this.el.sceneEl;
                const reticle = document.querySelector('#reticle');

                scene.addEventListener('click', () => {
                    if (reticle.getAttribute('visible') === true) {
                        // Create a new box
                        const newBox = document.createElement('a-box');
                        
                        // Set its position to match the reticle
                        newBox.setAttribute('position', reticle.getAttribute('position'));
                        newBox.setAttribute('rotation', reticle.getAttribute('rotation'));
                        newBox.setAttribute('color', '#4CC3D9');
                        newBox.setAttribute('scale', '0.2 0.2 0.2'); // Small box
                        
                        // Add to scene
                        scene.appendChild(newBox);
                    }
                });
            }
        });
    </script>
</head>

<body>
    <a-scene 
        embedded
        vr-mode-ui="enabled: false"
        ar-mode-ui="enabled: true; enterAREnabled: true"
        renderer="antialias: true; alpha: true; precision: medium;"
        webxr="requiredFeatures: hit-test; optionalFeatures: dom-overlay; overlayElement: #overlay">
        
        <a-entity camera position="0 1.6 0"></a-entity>

        <a-box position="0 1.5 -2" 
               rotation="0 45 0" 
               color="red" 
               animation="property: rotation; to: 0 405 0; loop: true; dur: 5000">
        </a-box>

        <a-light type="ambient" intensity="1"></a-light>
        <a-light type="directional" position="-1 2 1" intensity="1.5"></a-light>

    </a-scene>

    <div id="overlay" style="position: absolute; z-index: 1000; pointer-events: none;"></div>
</body>
</html>
